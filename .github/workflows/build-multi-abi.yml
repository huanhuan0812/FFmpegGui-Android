name: Build Multi-ABI Release

on:
  push:
    tags:
      - 'v*'           # 当推送版本标签时触发
    branches:
      - main
      - develop
  workflow_dispatch:    # 允许手动触发
    inputs:
      version_name:
        description: 'Version name (e.g., 1.0.0)'
        required: false
        default: '1.0'
      version_code:
        description: 'Version code'
        required: false
        default: '1'
      build_type:
        description: 'Build type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.jvmargs=-Xmx4096m"

jobs:
  build:
    name: Build APK for ${{ matrix.abi }}
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        abi: [armeabi-v7a, arm64-v8a, x86, x86_64]
      fail-fast: false  # 一个架构失败不影响其他架构

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android/build-cache
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/libs.versions.toml') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Update version in build.gradle.kts
        run: |
          # 更新版本号（如果是手动触发或标签触发）
          if [ "${{ github.event.inputs.version_name }}" != "" ]; then
            sed -i "s/versionName = \".*\"/versionName = \"${{ github.event.inputs.version_name }}\"/" app/build.gradle.kts
          fi
          if [ "${{ github.event.inputs.version_code }}" != "" ]; then
            sed -i "s/versionCode = .*/versionCode = ${{ github.event.inputs.version_code }}/" app/build.gradle.kts
          fi

      - name: Build ${{ matrix.abi }} APK
        run: |
          if [ "${{ github.event.inputs.build_type }}" = "debug" ] || [ "${{ github.ref_name }}" = "main" ]; then
            ./gradlew assembleDebug \
              -Pandroid.injected.build.api=36 \
              -Pandroid.injected.build.abi=${{ matrix.abi }} \
              --stacktrace
          else
            ./gradlew assembleRelease \
              -Pandroid.injected.build.api=36 \
              -Pandroid.injected.build.abi=${{ matrix.abi }} \
              --stacktrace
          fi

      - name: Rename APK with ABI info
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
          if [ "${{ github.ref_name }}" = "main" ]; then
            BUILD_TYPE="debug"
          fi
          
          VERSION="${{ github.event.inputs.version_name || '1.0' }}-${{ github.event.inputs.version_code || '1' }}"
          
          # 查找并重命名 APK
          for apk in app/build/outputs/apk/*/*/*.apk; do
            if [ -f "$apk" ]; then
              dir=$(dirname "$apk")
              mv "$apk" "$dir/app-${{ matrix.abi }}-${BUILD_TYPE}-${VERSION}.apk"
              echo "Renamed to: $dir/app-${{ matrix.abi }}-${BUILD_TYPE}-${VERSION}.apk"
            fi
          done

      - name: Upload ${{ matrix.abi }} APK
        uses: actions/upload-artifact@v4
        with:
          name: app-${{ matrix.abi }}-${{ github.event.inputs.build_type || 'release' }}
          path: app/build/outputs/apk/**/*.apk
          retention-days: 30
          if-no-files-found: error

  # 单独构建 universal APK（包含所有架构）
  build-universal:
    name: Build Universal APK
    runs-on: ubuntu-latest
    needs: build
    if: always()  # 即使部分架构失败也运行

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Universal APK
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
          if [ "${{ github.ref_name }}" = "main" ]; then
            BUILD_TYPE="debug"
            ./gradlew assembleDebug
          else
            ./gradlew assembleRelease
          fi

      - name: Upload Universal APK
        uses: actions/upload-artifact@v4
        with:
          name: app-universal-${{ github.event.inputs.build_type || 'release' }}
          path: app/build/outputs/apk/**/*.apk
          retention-days: 30

  # 创建 GitHub Release（仅当推送标签时）
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, build-universal]
    if: startsWith(github.ref, 'refs/tags/') && success()
    
    steps:
      - name: Download all APKs
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Display structure of downloaded files
        run: ls -R artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*.apk
          name: Release ${{ github.ref_name }}
          body: |
            ## Android FFmpeg GUI Release
            
            ### 包含的架构:
            - ARMv7 (armeabi-v7a) - 适用于旧款Android设备
            - ARM64 (arm64-v8a) - 适用于现代Android设备
            - x86 - 适用于模拟器
            - x86_64 - 适用于64位模拟器
            - Universal APK - 包含所有架构
            
            ### FFmpeg 信息:
            - 使用 ffmpeg-kit-lts-16kb:6.1.7
            - 支持多种音视频处理功能
            
            ### 构建信息:
            - 编译 SDK: Android 36
            - 最低支持: Android 8.0 (API 26)
            - 构建时间: ${{ github.event.repository.updated_at }}
            
            ### 安装说明:
            1. 根据您的设备架构选择合适的 APK
            2. 对于大多数现代设备，推荐使用 arm64-v8a 版本
            3. 如果不确定设备架构，可以使用 Universal APK
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
   